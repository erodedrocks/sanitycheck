<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Feed Cleanser</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            opacity: 0;
            animation: fadeIn 0.5s ease-out forwards;
        }

        @keyframes fadeIn {
            to { opacity: 1; }
        }

        .popup-container {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            padding: 40px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            text-align: center;
            position: relative;
            transform: scale(0.7) rotateY(45deg);
            animation: popIn 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55) 0.2s forwards;
        }

        @keyframes popIn {
            to {
                transform: scale(1) rotateY(0deg);
            }
        }

        .warning-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }

        .popup-title {
            color: white;
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .popup-message {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1.1rem;
            line-height: 1.6;
            margin-bottom: 30px;
        }

        .buttons-container {
            display: flex;
            gap: 20px;
            justify-content: center;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn-break {
            background: linear-gradient(45deg, #ff6b6b, #ff8e8e);
            color: white;
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
        }

        .btn-break:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.6);
        }

        .btn-cleanse {
            background: linear-gradient(45deg, #4ecdc4, #6bcf7e);
            color: white;
            box-shadow: 0 5px 15px rgba(78, 205, 196, 0.4);
        }

        .btn-cleanse:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(78, 205, 196, 0.6);
        }

        /* Timer Screen */
        .timer-screen {
            display: none;
        }

        .timer-screen.active {
            display: block;
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .grass-text {
            font-size: 3rem;
            color: #4ecdc4;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .timer-display {
            font-size: 4rem;
            color: white;
            font-weight: bold;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            border-radius: 4px;
            transition: width 0.1s ease;
        }

        .nature-emojis {
            font-size: 2rem;
            margin: 20px 0;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        .zen-message {
            color: rgba(255, 255, 255, 0.8);
            font-size: 1rem;
            font-style: italic;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div id="popupOverlay" class="popup-overlay">
        <div class="popup-container">
            <!-- Main Warning Screen -->
            <div id="warningScreen" class="warning-screen">
                <div class="warning-icon">‚ö†Ô∏è</div>
                <h2 class="popup-title">Woah, Slow Down!</h2>
                <p class="popup-message">
                    Your feed is getting pretty hefty. Remember, social media forces you into a bubble. 
                    Take a moment to breathe and reconnect with reality.
                </p>
                <div class="buttons-container">
                    <button id="breakBtn" class="btn btn-break">
                        OK - Take 3 Min Break
                    </button>
                    <button id="cleanseBtn" class="btn btn-cleanse">
                        Yes - Cleanse Feed
                    </button>
                </div>
            </div>

            <!-- Timer Screen -->
            <div id="timerScreen" class="timer-screen">
                <div class="grass-text">üå± Touch Some Grass üå±</div>
                <div id="timerDisplay" class="timer-display">3:00</div>
                <div class="progress-bar">
                    <div id="progressFill" class="progress-fill" style="width: 0%"></div>
                </div>
                <div class="nature-emojis">üåø ü¶ã üå∏ üå≥ ‚òÄÔ∏è</div>
                <div class="zen-message" id="zenMessage">
                    Step away from the screen and breathe...
                </div>
            </div>
        </div>
    </div>

    <script>
      let {discourager} = require('/x-feed-indicator-extension/scripts/discourager.js');
      let {processedTweets} = require('/x-feed-indicator-extension/scripts/content.js');
        class FeedCleanserPopup {
            constructor() {
                this.totalTime = 180; // 3 minutes in seconds
                this.timeLeft = this.totalTime;
                this.timer = null;
                this.zenMessages = [
                    "Step away from the screen and breathe...",
                    "Feel the sunlight on your skin...",
                    "Listen to the birds singing...",
                    "Notice the world around you...",
                    "Your mind is clearing...",
                    "Disconnect to reconnect...",
                    "Nature is calling your name...",
                    "Peace is found in stillness...",
                    "Your soul is recharging...",
                    "Almost time to return refreshed..."
                ];
                this.init();
            }

            init() {
                this.bindEvents();
            }

            bindEvents() {
                document.getElementById('breakBtn').addEventListener('click', () => {
                    this.startBreakTimer();
                });

                document.getElementById('cleanseBtn').addEventListener('click', () => {
                    this.cleanseFeed();
                });
            }

            startBreakTimer() {
                document.getElementById('warningScreen').style.display = 'none';
                document.getElementById('timerScreen').classList.add('active');
                
                this.timer = setInterval(() => {
                    this.updateTimer();
                }, 1000);

                // Change zen message every 20 seconds
                setInterval(() => {
                    this.updateZenMessage();
                }, 20000);
            }

            updateTimer() {
                this.timeLeft--;
                
                const minutes = Math.floor(this.timeLeft / 60);
                const seconds = this.timeLeft % 60;
                const displayTime = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                
                document.getElementById('timerDisplay').textContent = displayTime;
                
                // Update progress bar
                const progress = ((this.totalTime - this.timeLeft) / this.totalTime) * 100;
                document.getElementById('progressFill').style.width = `${progress}%`;
                
                if (this.timeLeft <= 0) {
                    this.completeBreak();
                }
            }

            updateZenMessage() {
                const randomMessage = this.zenMessages[Math.floor(Math.random() * this.zenMessages.length)];
                document.getElementById('zenMessage').textContent = randomMessage;
            }

            completeBreak() {
                clearInterval(this.timer);
                this.hidePopup();
                // Optional: Show a completion message
                setTimeout(() => {
                    alert('Welcome back! Hope you feel refreshed! üå±');
                }, 500);
            }

            async cleanseFeed() {
                // Show loading state
                document.getElementById('cleanseBtn').textContent = 'Cleansing...';
                document.getElementById('cleanseBtn').disabled = true;
                
                try {
                    // Get high-rated unwanted content (rating 4+)
                    const targetList = this.getHighRatedUnwantedContent();
                    
                    if (window.discourager && targetList.length > 0) {
                        await window.discourager.markTweetsNotInterested(targetList);
                        
                        // Success animation
                        document.getElementById('cleanseBtn').textContent = '‚úÖ Feed Cleansed!';
                        setTimeout(() => {
                            this.hidePopup();
                        }, 2000);
                    } else {
                        document.getElementById('cleanseBtn').textContent = 'No content to cleanse';
                        setTimeout(() => {
                            this.hidePopup();
                        }, 1500);
                    }
                } catch (error) {
                    console.error('Failed to cleanse feed:', error);
                    document.getElementById('cleanseBtn').textContent = 'Error occurred';
                    setTimeout(() => {
                        this.hidePopup();
                    }, 1500);
                }
            }

            async getHighRatedUnwantedContent() {
                // This would integrate with your rating system
                // For now, return example high-rated unwanted content
                if (window.discourager) {
                  
                    let targetTweetIds = Array.from(processedTweets.entries()).map(([key, value]) => {[key, value]});
                    const targetList = targetTweetIds.filter(tuple => tuple[1] >= 4);

                    await window.discourager.markTweetsNotInterested(targetList);
                    
                    unwantedKeywords.forEach(keyword => {
                        const tweets = window.discourager.getVisibleTweetsByKeyword(keyword);
                        targetList = [...targetList, ...tweets];
                    });
                    
                    // Filter for "high-rated" (4+) unwanted content
                    // You would implement your rating logic here
                    return targetList.filter(tweet => this.getRating(tweet) >= 4);
                }
                return [];
            }

            getRating(tweet) {
                // Implement your rating logic here
                // This is a placeholder that rates based on unwanted keywords
                let rating = 0;
                const text = tweet.text?.toLowerCase() || '';
                
                if (text.includes('sponsored') || text.includes('ad')) rating += 5;
                if (text.includes('crypto') || text.includes('nft')) rating += 4;
                if (text.includes('promoted')) rating += 4;
                if (tweet.author?.includes('bot')) rating += 3;
                
                return rating;
            }

            hidePopup() {
                document.getElementById('popupOverlay').style.animation = 'fadeIn 0.3s ease-out reverse';
                setTimeout(() => {
                    document.getElementById('popupOverlay').style.display = 'none';
                }, 300);
            }

            // Public method to show popup when criteria is met
            static checkAndShow() {
                if (window.discourager) {
                    const popup = new FeedCleanserPopup();
                    const highRatedContent = popup.getHighRatedUnwantedContent();
                    
                    // Show popup if there are 5+ high-rated unwanted items
                    if (highRatedContent.length >= 5) {
                        return popup;
                    }
                }
                return null;
            }
        }

        // Auto-check every 30 seconds
        setInterval(() => {
            FeedCleanserPopup.checkAndShow();
        }, 30000);

        // Initialize popup (for testing - remove this line for production)
        // new FeedCleanserPopup();
    </script>
</body>
</html>